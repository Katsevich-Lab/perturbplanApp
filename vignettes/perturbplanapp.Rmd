---
title: ""
output:
  html_document:
    toc: true
    toc_float: true
knit: (function(inputFile, encoding, ...) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_file = file.path(dirname(dirname(inputFile)), 'inst/app/www/perturbplanapp.html')) })
vignette: >
  %\VignetteIndexEntry{PerturbPlan App}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<div style="display: flex; align-items: center; margin-bottom: 30px;">
  <img src="logo.png" alt="PerturbPlan Logo" style="height: 120px; margin-right: 20px;">
  <h1 style="margin: 0; font-size: 2.5em;">PerturbPlan App</h1>
</div>

# Overview 

PerturbPlan is a Shiny app for perturb-seq and TAP-seq experimental design. It is structured around solving 11 commonly encountered design problems, balancing power and cost of the planned experiment. The workflow of the app proceeds as follows:

1. **Select a design problem**: Choose one of 11 predefined design problems that best matches your experimental goals.

2. **Configure design parameters**: Set the parameters for your experimental choices, analysis choices, expected effect sizes, and (optionally) advanced settings. Click "Plan". 

3. **View your analysis results**: The plot illustrates graphically how the design problem was solved, and the table below summarizes the optimal design parameters.

4. **Explore parameter settings.** Use the sliders to adjust key parameters and see how they affect the optimal design. Pin parameter settings to compare multiple designs.

5. **Export your results.** Click the export buttons to download the plot and a detailed Excel spreadsheet containing the results.

6. **Start over.** Click the "Restart" button to start from scratch.

We elaborate on steps 1-3, and 5 below. 

# Design problem selection

Currently, we support experimental design for two assays: Perturb-seq and TAP-seq. 

### Understanding Optimization Targets

PerturbPlan helps you design experiments by optimizing two key objectives:


- **Statistical power** is the probability of detecting a true effect if it exists. In CRISPR screens, power represents your ability to confidently identify perturbed elements that truly have an effect on the gene of interest.

  - **Higher power** = Greater confidence in detecting true positives.
  
  - **Target power**: Typically set to 0.8 (80%), meaning an 80% chance of detecting a real effect.
  
  - **Key insight**: Power increases with more cells, more reads, or relaxed effect size thresholds.


- **Experimental cost** is the total financial investment required to run your screen. Cost is determined by two main factors:

  - **Cell capture cost**: Number of cells × cost per captured cell (cost/cell).
  
  - **Sequencing cost**: Number of cells × reads per cell × cost per million reads (cost/million reads).

---


### Power-Only Workflows

These workflows focus solely on achieving target power by only minimizing power.

#### **Workflow 1: Minimize Cells per Target**

- **Goal**: Find the minimum number of cells per target needed to achieve target power.

- **What varies**: Number of cells receiving CRISPR perturbations on the same target.

- **What's fixed**: Reads per cell, expression threshold, fold change.

#### **Workflow 2: Minimize Reads per Cell**

- **Goal**: Find the minimum sequencing depth (reads per cell) needed to achieve target power.

- **What varies**: Sequenced reads per cell.

- **What's fixed**: Cells per target, expression threshold, fold change.

#### **Workflow 3: Minimize Expression Threshold**

- **Goal**: Find the minimum expression threshold needed to achieve target power.

- **What varies**: Expression threshold (Details of this variable can be found in the next section). 

- **What's fixed**: Cells per target, reads per cell, fold change.

- **Note**: Lower threshold = more lowly expressed genes included in analysis.

#### **Workflow 4: Minimize Fold Change**

- **Goal**: Find the minimum detectable fold change (effect size) at your target power.

- **What varies**: Minimum fold change of interest to detect.

- **What's fixed**: Cells per target, reads per cell, expression threshold.

#### **Workflow 5: Minimize Total Cost**

- **Goal**: Find the combination of cells and reads that achieves target power at minimum cost.

- **What varies**: Both cells per target AND reads per cell (jointly optimized).

- **What's fixed**: Expression threshold, fold change.

---

### Power + Cost Workflows

These workflows incorporate cost constraints into the optimization, finding the best design within your budget.

#### **Workflows 6-8: Minimize Expression Threshold**

**Common goal**: Achieve target power within budget while using the lowest possible expression threshold.

##### **Workflow 6: Expression Threshold Minimization (Cells Varying)**
- **What varies**: Expression threshold, cells per target.
- **What's fixed**: Reads per cell, fold change.
- **When to use**: You can adjust cell numbers but reads per cell is fixed.

##### **Workflow 7: Expression Threshold Minimization (Reads Varying)**
- **What varies**: Expression threshold, reads per cell.
- **What's fixed**: Cells per target, fold change.
- **When to use**: You can adjust reads per cell but cell numbers are fixed.

##### **Workflow 8: Expression Threshold Minimization (Cells + Reads Varying)**
- **What varies**: Expression threshold, cells per target, reads per cell.
- **What's fixed**: Fold change only.
- **When to use**: Maximum flexibility - you can adjust both cell numbers and reads per cell.

---

#### **Workflows 9-11: Minimize Fold Change**

**Common goal**: Achieve target power within budget while detecting the smallest possible fold change.

##### **Workflow 9: Fold Change Minimization (Cells Varying)**
- **What varies**: Fold change, cells per target.
- **What's fixed**: Reads per cell, expression threshold.
- **When to use**: You want to detect small effects; reads per cell is constrained.

##### **Workflow 10: Fold Change Minimization (Reads Varying)**
- **What varies**: Fold change, reads per cell.
- **What's fixed**: Cells per target, expression threshold.
- **When to use**: You want to detect small effects; cell numbers are constrained.

##### **Workflow 11: Fold Change Minimization (Cells + Reads Varying)**
- **What varies**: Fold change, cells per target, reads per cell.
- **What's fixed**: Expression threshold only.
- **When to use**: Maximum flexibility for detecting the smallest effects possible within budget.

---

<!-- ### How to Choose Your Workflow -->

<!-- Use this decision tree to select the appropriate workflow: -->

<!-- ### Step 1: Do you have a fixed budget constraint? -->

<!-- **No → Power-Only Mode (Workflows 1-5)** -->

<!-- - Want to minimize cells? → **Workflow 1** -->
<!-- - Want to minimize sequencing? → **Workflow 2** -->
<!-- - Want to test more genes (lower threshold)? → **Workflow 3** -->
<!-- - Want to know smallest detectable effect? → **Workflow 4** -->
<!-- - Want to minimize cost overall? → **Workflow 5** -->

<!-- **Yes → Power + Cost Mode (Workflows 6-11)** -->

<!-- ### Step 2: What do you want to optimize? -->

<!-- **Minimize expression threshold (test more genes):** -->

<!-- - Only cells can vary → **Workflow 6** -->
<!-- - Only reads can vary → **Workflow 7** -->
<!-- - Both cells and reads can vary → **Workflow 8** -->

<!-- **Minimize fold change (detect smaller effects):** -->

<!-- - Only cells can vary → **Workflow 9** -->
<!-- - Only reads can vary → **Workflow 10** -->
<!-- - Both cells and reads can vary → **Workflow 11** -->

<!-- --- -->

### Summary Table

| Workflow | Mode | Minimizing Target | Varying Parameters | Cost Constraint? |
|--|---------|--------------|-------------|----------|
| 1 | Power-only | Cells per target | Cells | No |
| 2 | Power-only | Reads per cell | Reads | No |
| 3 | Power-only | Expression threshold | Expression threshold | No |
| 4 | Power-only | Fold change | Fold change | No |
| 5 | Power-only | Total cost | Cells + Reads | No |
| 6 | Power + Cost | Expression threshold | Expression + Cells | Yes |
| 7 | Power + Cost | Expression threshold | Expression + Reads | Yes |
| 8 | Power + Cost | Expression threshold | Expression + Cells + Reads | Yes |
| 9 | Power + Cost | Fold change | Fold change + Cells | Yes |
| 10 | Power + Cost | Fold change | Fold change + Reads | Yes |
| 11 | Power + Cost | Fold change | Fold change + Cells + Reads | Yes |


# Design parameter configuration

Once you've selected your design problem, you need to configure the experimental parameters that define your screen. The sidebar is organized into four collapsible sections:

---

### Experimental Choices

These parameters define the basic experimental setup.

- **Reference expression data**: Expression data used to calculate statistical power. This data provides baseline gene expression statistics, library parameters and mapping efficiency that inform power calculations.

  - **Options**:
  
    - **Built-in**: Preprocessed data provided in [PerturbPlan package](https://katsevich-lab.github.io/perturbplan/reference/index.html#example-data).
    
    - **Custom**: Upload your own reference data.
    
  - **Custom data format**: The input must be an RDS file with the same structure as the output from [reference_data_preprocessing_10x( )](https://katsevich-lab.github.io/perturbplan/reference/reference_data_preprocessing_10x.html) or [reference_data_preprocessing( )](https://katsevich-lab.github.io/perturbplan/reference/reference_data_preprocessing.html) functions in the PerturbPlan package. The RDS file must contain:

    - `baseline_expression_stats`: Data frame with columns:
    
      - `response_id`: Ensembl Gene ID.
      
      - `relative_expression`: Relative gene expression.
      
      - `expression_size`: Expression variability parameter.

    - `library_parameters`: List with:
    
      - `UMI_per_cell`: Estimated total UMI counts per cell.
      
      - `variation`: Technical variation parameter.

    - `mapping_efficiency`: Ratio of sequenced reads confidently mapped to genes of interest.

  > **⚠️ TAP-seq Requirement**: TAP-seq assays require custom reference data. The built-in datasets are only available for Perturb-seq. A preprocessed [TAP-seq reference dataset](https://katsevich-lab.github.io/perturbplan/reference/K562_Ray.html) can be used for illustration.

- **Multiplicity of infection (MOI)**: The average number of sgRNA-carrying lentiviral particles that infect a single cell.

- **Number of targets**: The total number of genomic elements you plan to perturb in your screen.

- **gRNAs per target**: The number of different guide RNAs designed to perturb each target. 

  - **Why it matters**: Multiple gRNAs per target improve: (1) robustness against ineffective guides and (2) statistical power through replication.

- **Non-targeting gRNAs**: The number of control guide RNAs that do not target any genomic element. 

---

### Analysis Choices

These parameters define how power will be calculated and which perturbation-gene pairs will be analyzed.

- **Perturbation-gene pairs to analyze**: Method to construct the analysis set of perturbation-gene pairs for power calculation.

  - **Options**:
  
    - **Random pairing**: Genes surviving expression threshold filtering are paired with randomly sampled perturbations. Appropriate when you don't have prior knowledge about which genes respond to which perturbations.
    
    - **Custom pairing**: Upload a specific set of (perturbation, gene) pairs for analysis. Appropriate when you have prior knowledge or hypotheses about specific interactions.
    
      - **Required format**: RDS file containing a data frame with two columns:
      
        - `grna_target`: Perturbation identifier (genomic element being targeted)
        
        - `response_id`: Gene identifier (gene whose expression is being measured)

- **Test side**: Sideness of the hypothesis test when inferring the perturbation effect. Three options are provided:

  - **Left**: Left-sided test will be considered. Appropriate for testing knockout or knockdown effect.
  
  - **Right**: Right-sided test will be considered. Appropriate for testing activation effect.
  
  - **Both**: Both-sided test will be considered. Appropriate when effect direction is unknown.

- **TPM analysis threshold**: Transcripts per million, scale for expression threshold when Perturb-seq experiment is planned.

- **UMIs/cell at saturation**: UMIs per cell when sequencing is saturated, scale for expression threshold when TAP-seq experiment is planned.

---

### Effect Sizes

These parameters define the biological effects you want to detect.

- **Fold change**: The minimum effect size of interest, expressed as a multiplicative fold change in gene expression.

  - **Interpretation**:
  
    - **Fold change = 1.0**: No effect (null hypothesis).
    
    - **Fold change < 1.0**: Negative/inhibitory effect (e.g., 0.8 = 20% decrease in expression).
    
    - **Fold change > 1.0**: Positive/activating effect (e.g., 1.5 = 50% increase in expression).

- **Proportion of non-null pairs**: The fraction of perturbation-gene pairs expected to have signal greater than the minimum effect size of interest. 

  - **Why it matters**: Higher proportions of non-null pairs increase statistical power by reducing the impact of multiple testing corrections.


---

### Advanced Settings

These advanced parameters provide fine-grained control over technical aspects of the analysis.

- **gRNA variability**: Effect size variability of multiple gRNAs targeting the same genomic element.

  - **Why it matters**: Higher gRNA variability reduces power because multiple gRNAs targeting the same element may have different effect and such variability increases noise in the data, which requires more cells to achieve the same power.
  
  - **Technical details**: The effect size of each gRNA, given the fold change $\beta$ and gRNA variability $\sigma$, can be thought of as a draw from the normal distribution $N(\beta, \sigma^2)$.

- **Mapping efficiency**: The ratio of sequencing reads that map confidently to the genes of interest. 

  - **Why it matters**: Lower mapping efficiency effectively reduces your sequencing depth, requiring more total reads to achieve the same power.
  
  - **Definition varies by assay**:
  
    - **Perturb-seq**: Fraction of reads mapping to all expressed genes in the cell type.
    
    - **TAP-seq**: Fraction of reads mapping to pre-specified target genes.
    
  - **Typical values**: 
  
    - **0.65-0.75**: Standard for Perturb-seq with genome-wide profiling.
    
    - **0.7-0.9**: High-quality libraries or TAP-seq with optimized probes.
    
    - **< 0.5**: Poor library quality or high off-target mapping.

- **Control group**: The strategy used to construct control cells for baseline expression and statistical comparisons.

  - **Options**:
  
    - **Complement cells**: cells that do not receive the perturbation being tested, but may receive other perturbations.
    
      - **When required**: MOI > 1 (high MOI experiments).
      
      - **Use case**: High-throughput screens where each cell receives multiple perturbations.
      
    - **Non-targeting cells**: cells that receive only non-targeting control gRNAs.
    
      - **When available**: MOI = 1 (low MOI experiments).
      
      - **Use case**: Clean control group with no intended perturbations.
      
  - **Automatic behavior**: When MOI > 1, the app automatically selects "Complement cells" as the control group, since most cells will have multiple perturbations.

---

# Analysis result interpretation

# Exported table format


