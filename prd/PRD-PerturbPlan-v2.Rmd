---
title: "PerturbPlan Shiny App v2 - Product Requirements Document"
author: "Ziang Niu"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(knitr)
```

# Executive Summary

## Problem Statement

The original PerturbPlan Shiny app (located in the `perturbplan` R package at `inst/shiny/`) forces users through a generic workflow that doesn't align with their specific experimental constraints and decision-making process. Users need to specify their design priorities (power vs cost optimization) and parameter constraints upfront to get relevant guidance.

## Solution Overview

PerturbPlan v2 redesigns the user workflow around **constraint-driven experimental design**. Users first specify their optimization objective and parameter constraints, then the app presents tailored analysis options based on their specific design problem.

## Key Objectives

1. **User-centric workflow**: Design process starts with user's specific constraints and objectives
2. **Flexible parameter control**: Users specify which parameters to vary vs. fix based on their experimental reality
3. **Optimization-focused**: Clear distinction between power optimization vs. cost optimization scenarios
4. **Streamlined interface**: Consolidate parameter selection into logical design module

# User Stories & Personas

## Primary Users

**Experimental Biologists** planning CRISPR perturb-seq experiments who need to balance:
- Limited budget (cost constraints)
- Required statistical power (detection constraints)
- Technical limitations (cell availability, sequencing capacity)

## User Goals

1. **Optimize experimental design** within their specific constraints
2. **Make informed trade-offs** between power and cost
3. **Focus analysis** on parameters they can actually control
4. **Get actionable recommendations** for their specific situation

## Current Pain Points (Original App in `perturbplan` Package)

- Generic workflow doesn't match user's specific constraints
- Parameter selection scattered across multiple UI sections
- No clear optimization framework (power vs. cost)
- Users must mentally translate generic results to their specific situation

# Functional Requirements

## Core Features

### Module 1: Design Options (NEW)

#### 1.1 Optimization Constraints Selection
**Power is always constrained. User specifies whether to include cost considerations:**
- **Constrain power only**: "Optimize power without cost constraints"
- **Constrain power and cost**: "Optimize power while considering cost constraints"

#### 1.2 Power and Cost Requirements
**After selecting optimization constraints, user must specify:**

- **Target Power**: Required statistical power (e.g., 0.8 for 80% power)
  - Always required for all optimization scenarios
  - Numeric input with range 0.1 to 0.99, step 0.05, default 0.8

- **Cost Budget**: Maximum budget constraint (only for "Constrain power and cost")
  - Required when cost constraints are included
  - Numeric input in dollars, range $100 to $1,000,000, step $500, default $10,000
  - Hidden when "Constrain power only" is selected

**Progressive Disclosure**: Step 2 (Minimization Target) only appears after required power/cost inputs are provided.

#### 1.3 Minimization Target Selection
**User selects what to minimize (all parameters available regardless of optimization type):**

- [ ] Minimize total cells per target
- [ ] Minimize reads per cell
- [ ] Minimize total cost (computed from cells × reads)
- [ ] Minimize TPM analysis threshold (maximize gene coverage)
- [ ] Minimize minimum fold change (maximize sensitivity)

**Note**: When **Constrain power and cost** is selected, **total cost** will not be used as an optimization target since cost is already being considered as a constraint. All individual parameters remain available for optimization.

#### 1.4 Parameter Control Panel
**Dynamically displays only parameters relevant for user configuration. Parameter types:**

- **Minimizing parameters**: Completely omitted from Step 3 (redundant since already selected as target)
- **Optimizing parameters**: Omitted when varying simultaneously (e.g., cells+reads in cost minimization)
- **Fixed parameters**: Show only input box (no dropdown) for specifying constraint values
- **Varying parameters**: Show dropdown to choose "Varying" or "Fixed", with conditional input for fixed values

**Current Implementation Logic:**
- **Step 3 shows only configurable parameters** - parameters being minimized or optimized automatically are omitted entirely
- **Fixed parameters get streamlined UI** - no unnecessary dropdown, just the value input
- **Space-efficient design** - eliminates redundant controls and focuses on user-controllable aspects
- **Smart parameter detection** based on selected workflow:
  - Single parameter minimization: Show all others as fixed
  - Cost minimization: Show only TPM/FC as fixed (cells/reads optimized together)
  - Power+cost scenarios: Show relevant parameter combinations based on target

### Modules 2+: Analysis Modules (ADAPTED FROM ORIGINAL APP)

#### Adapted from Original App (`perturbplan` package `inst/shiny/`)
- **Experimental Setup**: Pilot data, library parameters (minus TPM/fold change controls moved to Module 1)
- **Results Visualization**: TBD - plotting functionality to be specified in later development phases
- **Results Export**: Excel downloads, data export functionality

#### Key Changes from Original App
- **Remove duplicate controls**: TPM threshold and minimum fold change now controlled in Module 1
- **Context-aware analysis**: Analysis respects constraints from Design Options module
- **Optimization-focused results**: Results emphasize minimization targets specified in Module 1
- **Deferred visualization**: Specific plotting and visualization components will be designed separately

#### Visualization Specifications

##### Power-Only Optimization Plots (5 designs)

**Single Parameter Power Curves (Workflows 1-4: Cell/Read/TPM/FC minimization)**
- **Y-axis**: Power 
- **X-axis**: Parameter being minimized (cells per target, reads per cell, TPM threshold, or minimum fold change)
- **Gray-out region**: Power values below required threshold
- **Dashed vertical line**: Indicates minimizer value (intersects x-axis)
- **Example**: Minimize cells per target → power curve over cells, gray out power < target, dashed line at optimal cell count

**Cost-Power Trade-off Plots (Workflow 5: Total cost minimization)**
- **Equi-power curve**: Hyperbolic curve (y = 1/x style) showing constant power combinations
- **Equi-cost curve**: Linear tangent line (y = C - c/x style) representing cost constraint
- **Axes**: Cells per target (x) vs. Reads per cell (y)
- **Triangle marker**: Indicates optimal design at tangent point
- **Dashed lines**: Vertical and horizontal reference lines through optimal design point

##### Power + Cost Optimization Plots (6 designs)

**Two-Parameter Varying Plots (Workflows 8, 11: Cells + Reads varying)**
- **Equi-power curve**: Shows combinations achieving optimal TPM/FC target
- **Equi-cost curve**: Shows cost constraint boundary
- **Axes**: Cells per target (x) vs. Reads per cell (y)
- **Intersection point**: Optimal design balancing power and cost constraints

**Single Parameter Varying Plots (Workflows 6, 7, 9, 10: One parameter varies)**
- **Y-axis**: Power
- **X-axis**: Parameter being optimized (TPM threshold or minimum fold change)
- **Gray-out region**: Power values below required threshold  
- **Dashed vertical line**: Indicates optimal parameter value
- **Note**: Similar to single parameter power curves but within cost constraints

## User Workflows

**Important Note**: The current PerturbPlan implementation does not support other functionalities beyond the 11 workflows specified below. These 11 workflows represent all supported parameter control combinations and optimization scenarios.

### Power-Only Optimization Routes (5 workflows)

#### Workflow 1: Minimize Cells per Target
- **Optimization**: Power-only 
- **Target**: Minimize cells per target
- **Parameter Control**: 
  - Cells per target: Varying
  - Reads per cell: Fixed
  - TPM threshold: Fixed  
  - Min fold change: Fixed

#### Workflow 2: Minimize Reads per Cell
- **Optimization**: Power-only
- **Target**: Minimize reads per cell  
- **Parameter Control**:
  - Cells per target: Fixed
  - Reads per cell: Varying
  - TPM threshold: Fixed
  - Min fold change: Fixed

#### Workflow 3: Minimize TPM Threshold
- **Optimization**: Power-only
- **Target**: Minimize TPM analysis threshold
- **Parameter Control**:
  - Cells per target: Fixed
  - Reads per cell: Fixed
  - TPM threshold: Varying
  - Min fold change: Fixed

#### Workflow 4: Minimize Fold Change
- **Optimization**: Power-only
- **Target**: Minimize minimum fold change
- **Parameter Control**:
  - Cells per target: Fixed
  - Reads per cell: Fixed
  - TPM threshold: Fixed
  - Min fold change: Varying

#### Workflow 5: Minimize Total Cost
- **Optimization**: Power-only
- **Target**: Minimize total cost
- **Parameter Control**:
  - Cells per target: Varying
  - Reads per cell: Varying
  - TPM threshold: Fixed
  - Min fold change: Fixed

### Power + Cost Optimization Routes (6 workflows)

#### Workflow 6: Minimize TPM with TPM + Cells Varying
- **Optimization**: Power + cost
- **Target**: Minimize TPM analysis threshold
- **Parameter Control**:
  - Cells per target: Varying
  - Reads per cell: Fixed
  - TPM threshold: Varying
  - Min fold change: Fixed

#### Workflow 7: Minimize TPM with TPM + Reads Varying
- **Optimization**: Power + cost
- **Target**: Minimize TPM analysis threshold
- **Parameter Control**:
  - Cells per target: Fixed
  - Reads per cell: Varying
  - TPM threshold: Varying
  - Min fold change: Fixed

#### Workflow 8: Minimize TPM with TPM + Cells + Reads Varying
- **Optimization**: Power + cost
- **Target**: Minimize TPM analysis threshold
- **Parameter Control**:
  - Cells per target: Varying
  - Reads per cell: Varying
  - TPM threshold: Varying
  - Min fold change: Fixed

#### Workflow 9: Minimize Fold Change with FC + Cells Varying
- **Optimization**: Power + cost
- **Target**: Minimize minimum fold change
- **Parameter Control**:
  - Cells per target: Varying
  - Reads per cell: Fixed
  - TPM threshold: Fixed
  - Min fold change: Varying

#### Workflow 10: Minimize Fold Change with FC + Reads Varying
- **Optimization**: Power + cost
- **Target**: Minimize minimum fold change
- **Parameter Control**:
  - Cells per target: Fixed
  - Reads per cell: Varying
  - TPM threshold: Fixed
  - Min fold change: Varying

#### Workflow 11: Minimize Fold Change with FC + Cells + Reads Varying
- **Optimization**: Power + cost
- **Target**: Minimize minimum fold change
- **Parameter Control**:
  - Cells per target: Varying
  - Reads per cell: Varying
  - TPM threshold: Fixed
  - Min fold change: Varying

# UI/UX Requirements

## Design Requirements

### Visual Continuity
- **Preserve existing color scheme, typography, and layout patterns**
- **Reuse current UI components**: buttons, input controls, plot styling
- **Maintain familiar navigation structure** where possible
- **Keep existing visual hierarchy and branding**

### User Experience Continuity
- **Progressive disclosure**: Build on existing mental models
- **Consistent terminology**: Preserve established parameter names
- **Familiar interaction patterns**: Keep successful UI elements from v1

## Navigation Structure

### Module-Based Navigation
```
┌─ Design Options (NEW PRIMARY MODULE)
│   ├─ Optimization Objective
│   ├─ Minimization Target  
│   └─ Parameter Controls
│
├─ Experimental Setup (INHERITED, MODIFIED)  
│   ├─ Pilot Data Upload
│   ├─ Library Parameters
│   └─ [TPM/Fold Change REMOVED - now in Design Options]
│
├─ Analysis Results (NEW/MODIFIED)
│   ├─ Optimization Results Display
│   └─ Placeholder Visualization (power curves, cost curves)
│
└─ Export Results (INHERITED)
    ├─ Excel Downloads
    └─ Data Export
```

## Information Architecture

### Design Options Module Layout

#### Step 1: Optimization Constraints
```
┌─ Step 1: Optimization Constraints
│  ○ Constrain power only
│  ○ Constrain power and cost
└─
```

#### Power and Cost Requirements (appears after Step 1)
```
┌─ Power and Cost Requirements
│  ┌─ Target Power: [0.8_____] (0.1-0.99, always shown)
│  └─ Cost Budget ($): [10000___] (only for power+cost, hidden otherwise)
└─
```

#### Step 2: Minimization Target (appears after requirements)
```
┌─ Step 2: Minimization Target
│  ☐ Minimize total cells per target
│  ☐ Minimize reads per cell  
│  ☐ Minimize total cost (hidden for power+cost constraints)
│  ☐ Minimize TPM analysis threshold
│  ☐ Minimize minimum fold change
└─
```

#### Step 3: Parameter Control (dynamic, workflow-based)
```
┌─ Step 3: Power-determining Parameters Setup
│  [Shows only configurable parameters - minimizing/optimizing ones omitted]
│  
│  Example scenarios:
│  • Single param minimization: Show 3 others as fixed-only inputs
│  • Cost minimization: Show only TPM/FC as fixed-only inputs  
│  • Power+cost: Show relevant varying/fixed combinations
│  
│  Fixed parameters: [Label] [____input____] (no dropdown)
│  Varying parameters: [Label] [Varying▼Fixed] [conditional_input]
└─
```

## Interaction Patterns

### Progressive Disclosure
1. **Step 1: Optimization constraints selection** → reveals power/cost requirements section
2. **Power/cost requirements completion** → reveals Step 2 (minimization targets)
3. **Step 2: Minimization target selection** → reveals Step 3 (parameter controls) 
4. **Step 3: Dynamic parameter display** → shows only configurable parameters based on workflow
5. **Complete design specification** → enables analysis modules

### Reset Behavior
- **Changing Step 1**: Resets power/cost inputs to defaults, hides subsequent steps
- **Changing power/cost inputs**: Validates requirements before showing Step 2
- **Changing Step 2**: Regenerates Step 3 parameter controls based on new workflow

### Validation & Feedback
- **Real-time validation**: Ensure at least one varying parameter
- **Smart defaults**: Suggest reasonable parameter ranges
- **Clear error messages**: Guide users to valid configurations

# Technical Requirements

## Golem Architecture

### Planned Module Structure

```r
# Module 1: New Design-Centric Module
mod_design_options.R
├─ mod_design_options_ui()
├─ mod_design_options_server()
└─ Sub-components:
   ├─ optimization_objective_ui/server
   ├─ minimization_target_ui/server  
   └─ parameter_control_ui/server

# Modules 2+: Adapted from Current App
mod_experimental_setup.R   # Modified: remove TPM/fold change
mod_analysis_results.R     # NEW: optimization results display
mod_results_export.R      # Inherited: downloads and data export
```

### Data Flow Architecture

```r
# Design Options Module outputs
design_config <- list(
  optimization_type = "power_cost",  # or "power_only"
  target_power = 0.8,  # Required statistical power
  cost_budget = 10000,  # Budget constraint (NULL for power_only)
  minimization_target = "tpm_threshold", 
  parameter_controls = list(
    cells_per_target = list(type = "varying", fixed_value = NULL),
    reads_per_cell = list(type = "fixed", fixed_value = 5000),
    tpm_threshold = list(type = "minimizing", fixed_value = NULL),
    min_fold_change = list(type = "fixed", fixed_value = 1.5)
  )
)

# Consumed by downstream modules
```

## UI Framework Continuity

### Asset Migration Strategy
- **Copy existing CSS** from `../perturbplan/inst/shiny/www/` to `inst/app/www/`
- **Preserve JavaScript** customizations and interactions from original app
- **Maintain responsive layouts** and accessibility patterns
- **Reuse plot themes** and color schemes from original app

### Component Reuse from Original App
- **Form controls**: Leverage existing input styling from `perturbplan` app
- **Navigation elements**: Adapt tab/module structure from original app
- **Data tables**: Preserve existing DT configurations from original app
- **Results display**: Reuse table and summary formatting patterns from original app
- **Note**: Plot styling deferred until visualization requirements specified

## Performance Requirements

- **Fast parameter updates**: Real-time validation and preview
- **Efficient grid computation**: Handle varying parameter optimization
- **Responsive UI**: Sub-second feedback for design option changes

# Success Metrics

## User Experience Improvements

- **Reduced time to first meaningful result**: Users get relevant analysis faster
- **Higher task completion rate**: More users successfully design experiments
- **Improved user satisfaction**: Workflow matches user mental model

## Feature Adoption

- **Design Options usage**: Track optimization objective selections
- **Parameter control patterns**: Monitor varying vs. fixed parameter choices
- **Analysis depth**: Measure progression through analysis modules

# Implementation Plan

## Phase 1: Design Options Module (2-3 weeks)
- [ ] Create `mod_design_options.R` with three sub-components
- [ ] Implement optimization objective selection logic
- [ ] Build parameter control matrix interface
- [ ] Add validation and business logic

## Phase 2: Placeholder Visualization & Module Integration (2-3 weeks)

### Design Config Data Flow
- [x] Create reactive design config output from `mod_design_options`
- [x] Structure config to capture optimization type, minimization target, and parameter controls
- [x] Pass design config between modules: Design Options → Analysis Results → Export Results

### Module Communication Setup
- [x] Implement design config consumption in `mod_analysis_results`
- [x] Create workflow detection logic to identify which of 11 scenarios user has configured
- [ ] Route to appropriate visualization type based on workflow pattern
- [x] Adapt `mod_experimental_setup` from original app, removing duplicate TPM/fold change controls

### Placeholder Visualization Implementation
- [ ] Create placeholder power curve plots for 5 power-only designs:
  - Single parameter power curves (Workflows 1-4: Cell/Read/TPM/FC minimization)
  - Cost-power trade-off plots (Workflow 5: Total cost minimization)
- [ ] Create placeholder power + cost optimization plots for 6 designs:
  - Two-parameter varying plots (Workflows 8, 11: Cells + Reads varying)
  - Single parameter varying plots (Workflows 6, 7, 9, 10: One parameter varies)
- [ ] Implement interactive plot elements:
  - Gray-out regions for power values below threshold
  - Dashed vertical/horizontal lines indicating optimal values
  - Triangle markers for optimal design points
  - Equi-power and equi-cost curves with intersection points

### Workflow Routing Logic
- [x] Implement scenario detection:
  - Power-only + single parameter varying → single parameter power curve
  - Power-only + cost minimization → cost-power trade-off plot
  - Power + cost + two parameters varying → equi-power/equi-cost intersection
  - Power + cost + single parameter varying → constrained power curve
- [ ] Create parameter passing logic for each visualization type
- [x] Validate parameter control consistency (one minimizing parameter auto-set, all others grayed out)

### End-to-End Integration Testing
- [x] Test all 11 workflow configurations can be set up through Design Options
- [ ] Verify correct visualization type is displayed for each workflow
- [x] Test parameter control panel auto-updates (one minimizing status, all others grayed out)
- [x] Validate data flow integrity across all modules

### Results Display Framework
- [ ] Create `mod_analysis_results.R` module with placeholder visualizations
- [ ] Implement conditional rendering based on workflow detection
- [ ] Add results summary tables with placeholder data
- [ ] Create export functionality for placeholder results

## Phase 3: Analysis Engine Integration (3-4 weeks) - DEFERRED
- [ ] Adapt power analysis functions from perturbplan package for optimization scenarios
- [ ] Implement cost minimization algorithms using perturbplan backend
- [ ] Update analysis for varying vs. fixed parameters with real calculations
- [ ] Replace placeholder data with real power analysis results
- [ ] Create results display module with real data (tables, summaries)
- [ ] Enhance results interpretation with perturbplan function outputs

## Phase 5: UI Polish & Testing (1-2 weeks)
- [ ] Apply visual continuity requirements
- [ ] User testing with constraint-based scenarios
- [ ] Performance optimization
- [ ] Documentation updates

# Appendices

## Business Logic Validation Rules

### Parameter Control Constraints
- **At least one varying parameter** required
- **Maximum 2 fixed values** per parameter
- **Logical parameter ranges** enforced
- **Optimization objective consistency** validated

## Original App Reference (`perturbplan` Package)

### UI Elements to Preserve from Original App
- Color scheme and typography from `perturbplan/inst/shiny/ui/ui_styles.R`
- Button and input styling from original app
- Navigation patterns from `perturbplan/inst/shiny/ui/ui_main.R`
- Table and results formatting from original app
- **Note**: Plot themes and layouts TBD when visualization is specified

### Controls to Migrate from Original App
- TPM analysis threshold (move from Experimental Setup → Design Options Module)
- Minimum fold change (move from Experimental Setup → Design Options Module)  
- All other controls adapted from original app structure
- Pilot data upload functionality from `perturbplan/inst/shiny/server/server_main.R`